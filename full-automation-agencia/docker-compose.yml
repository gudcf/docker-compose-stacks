version: '3.8'

services:
  # ===========================================
  # CORE - Banco e Cache
  # ===========================================
  postgres:
    image: pgvector/pgvector:pg14
    restart: always
    environment:
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_DB=postgres
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    restart: always
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s

  # ===========================================
  # MINIO - S3 Storage Local
  # ===========================================
  minio:
    image: minio/minio
    restart: always
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_PASSWORD}
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]

  # ===========================================
  # TYPEBOT - Builder & Viewer
  # ===========================================
  typebot-builder:
    image: baptistearno/typebot-builder:latest
    restart: always
    environment:
      - DATABASE_URL=postgresql://postgres:${DB_PASSWORD}@postgres:5432/typebot_db
      - NEXTAUTH_URL=https://${TYPEBOT_BUILDER_DOMAIN}
      - NEXT_PUBLIC_VIEWER_URL=https://${TYPEBOT_VIEWER_DOMAIN}
      - ENCRYPTION_SECRET=${TYPEBOT_SECRET}
      - S3_ENDPOINT=minio
      - S3_PORT=9000
      - S3_ACCESS_KEY=${MINIO_USER}
      - S3_SECRET_KEY=${MINIO_PASSWORD}
      - S3_BUCKET=typebot
      - S3_SSL=false
    depends_on:
      - postgres
      - minio

  typebot-viewer:
    image: baptistearno/typebot-viewer:latest
    restart: always
    environment:
      - DATABASE_URL=postgresql://postgres:${DB_PASSWORD}@postgres:5432/typebot_db
      - NEXT_PUBLIC_VIEWER_URL=https://${TYPEBOT_VIEWER_DOMAIN}
    depends_on:
      - postgres

  # ===========================================
  # CHATWOOT - Atendimento
  # ===========================================
  chatwoot-web:
    image: chatwoot/chatwoot:latest
    restart: always
    command: bundle exec rails s -p 3000 -b 0.0.0.0
    entrypoint: docker/entrypoints/rails.sh
    environment:
      - FRONTEND_URL=https://${CHATWOOT_DOMAIN}
      - POSTGRES_HOST=postgres
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - REDIS_URL=redis://redis:6379
      - SECRET_KEY_BASE=${CHATWOOT_SECRET}
      - NODE_ENV=production
    depends_on:
      - postgres
      - redis
    volumes:
      - chatwoot_data:/app/storage

  # ===========================================
  # MONITORAMENTO
  # ===========================================
  uptime-kuma:
    image: louislam/uptime-kuma:1
    restart: always
    volumes:
      - uptime_data:/app/data

volumes:
  postgres-data:
  redis-data:
  minio_data:
  chatwoot_data:
  uptime_data:
